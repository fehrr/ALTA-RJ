----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- CONEXAO
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local Tunnel = module("vrp","lib/Tunnel")
local Proxy = module("vrp","lib/Proxy")
vRP = Proxy.getInterface("vRP")
src = {}
Tunnel.bindInterface("hud",src)
vSERVER = Tunnel.getInterface("hud")

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- VARIABLES
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local voice = 2
local showHud = true
local talking = false
local radioDisplay = ""

local hours = 10
local minutes = 20

local flexDirection = "Norte"
local streetName = "Rua Boliva da Silva Mirto"

local cacheStreet = {}
local inFarm = false
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- SEATBELT
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local sBuffer = {}
local cinto_seguranca = false
local ExNoCarro = false

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PROGRESS
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("Progress")
AddEventHandler("Progress",function(progressTimer)
	SendNUIMessage({ progress = true, progressTimer = parseInt(progressTimer - 500) })
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- THREADHUD
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		time = 500

		if showHud then
			if IsPedInAnyVehicle(PlayerPedId()) then
				time = 100
				updateDisplayHud(true)
			else
				updateDisplayHud(false)
			end
		end

		Wait(time)
	end
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- UPDATEDISPLAYHUD
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
function updateDisplayHud(inVehicle)
	local ped = PlayerPedId()
	local health = GetEntityHealth(ped)
	local armour = GetPedArmour(ped)

	local assaultTime = false

	if tonumber(GetClockHours()) >= 0 and tonumber(GetClockHours()) < 8 then
		assaultTime = true
	else
		assaultTime = false
	end

	if inVehicle then
		local vehicle = GetVehiclePedIsUsing(ped)
		local doorstatus = (GetVehicleDoorLockStatus(vehicle) == 2)
		local _,lights,highlights = GetVehicleLightsState(vehicle)
		local engine = GetVehicleEngineHealth(vehicle)/10
		local fuel = GetVehicleFuelLevel(vehicle)
		local speed = GetEntitySpeed(vehicle) * 3.6
		local rpm = GetVehicleCurrentRpm(vehicle)
		if lights == 1 and highlights == 0 then
			lights = 1
		end

		if highlights == 1 then
			lights = 2
		end

		SendNUIMessage({ vehicle = true, talking = talking, health = health, street = streetName, direction = flexDirection, radio = radioDisplay, voice = voice, fuel = fuel, speed = speed, time = hours..":"..minutes, seatbelt = cinto_seguranca, doorstatus = doorstatus, lights = lights, engine = engine, rpm = rpm, armour = armour, assaultTime = assaultTime })
	else
		SendNUIMessage({ vehicle = false, talking = talking, health = health, street = streetName, direction = flexDirection, radio = radioDisplay, voice = voice, time = hours..":"..minutes, armour = armour, assaultTime = assaultTime })
	end

	if not inFarm then
		DisplayRadar(inVehicle)
	else
		DisplayRadar(true)
	end
end

local lastTimer = GetGameTimer()
CreateThread(function()
	while true do

		if showHud then
			local coords = GetEntityCoords(ped)
			local heading = GetEntityHeading(ped)
			

			if (GetGameTimer() - lastTimer) > 0 then
				local streetHash = GetStreetNameAtCoord(coords.x,coords.y,coords.z)
				if not cacheStreet[streetHash] then
					cacheStreet[streetHash] = GetStreetNameFromHashKey(streetHash)
				end
				streetName = cacheStreet[streetHash]

				lastTimer = (GetGameTimer() + 10000)
			end

			if heading >= 315 or heading < 45 then
				flexDirection = "Norte"
			elseif heading >= 45 and heading < 135 then
				flexDirection = "Oeste"
			elseif heading >= 135 and heading < 225 then
				flexDirection = "Sul"
			elseif heading >= 225 and heading < 315 then
				flexDirection = "Leste"
			end

			hours = GetClockHours()
			minutes = GetClockMinutes()
		
			if hours <= 9 then
				hours = "0"..hours
			end
		
			if minutes <= 9 then
				minutes = "0"..minutes
			end
		end

		Wait( 1000 )
	end
end)


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- NOTIFY
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

local types = {
	['vip'] = {
			title = 'vip',
			index = 'vip',
	},
	['sucesso'] = {
			title = 'SUCESSO',
			index = 'success',
	},
	['negado'] = {
			title = 'NEGADO',
			index = 'refused',
	},
	['importante'] = {
			title = 'IMPORTANTE',
			index = 'important',
	},
	['hospital'] = {
			title = 'HOSPITAL',
			index = 'hospital',
	},
	['police'] = {
			title = 'POLICIA',
			index = 'police',
	},
	['mechanic'] = {
			title = 'MECANICO',
			index = 'mechanic'
	},
	['aviso'] = {
			title = 'AVISO',
			index = 'important'
	},
	['avisoadm'] = {
		title = 'AVISO ADM',
		index = 'avisoadm'
	},
	['event'] = {
		title = 'EVENTO',
		index = 'event'
	}
}

RegisterNetEvent("Notify")
AddEventHandler("Notify",function(css,mensagem,timer,title)
	if not timer or timer == "" or timer > 1000 then
		timer = 5 
	end

	if (not types[css]) then return print(css .. ' does not exist') end

	if (not title) then
		title = types[css].title
	end

	SendNUIMessage({ css = types[css].index, mensagem = mensagem, timer = timer * 1000, title = types[css].title })
end)

RegisterNetEvent('flaviin:setPlayerTalking')
AddEventHandler('flaviin:setPlayerTalking', function(enable, name, user_id)
  if not enable then
    SendNUIMessage({
      action = 'removeUser',
      user_id = user_id
    })
    return
  end
  SendNUIMessage({
    action = 'appendUser',
    name = name,
    user_id = user_id
  })
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- HUD
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
RegisterCommand("hud",function(source,args)
	if vSERVER.checkhud() then
		showHud = not showHud
		SendNUIMessage({ hud = showHud })
	end
end)

RegisterNetEvent("flaviin:toggleHud")
AddEventHandler("flaviin:toggleHud", function(enabled)
	SendNUIMessage({ hud = enabled })
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- HUD:ACTIVE
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("hudActived")
AddEventHandler("hudActived",function(status)
	showHud = status
	SendNUIMessage({ hud = showHud })
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- HUD:VOICEMODE
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("pma-voice:setTalkingMode")
AddEventHandler("pma-voice:setTalkingMode",function(status)
	voice = status
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- HUD:VOICETALKING
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
AddEventHandler("vrp_hud:VoiceTalking",function(status)
	talking = status
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- HUD:RADIODISPLAY
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("lotus-hud:setRadioFrequency")
AddEventHandler("lotus-hud:setRadioFrequency",function(number)
	if parseInt(number) <= 0 then
		radioDisplay = ""
	else
		radioDisplay = parseInt(number)
	end
end)

AddEventHandler('onClientResourceStart', function (resourceName)
	if(GetCurrentResourceName() ~= resourceName) then
		return
	end

	showHud = true
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- CINTO DE SEGURANCA
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
IsCar = function(veh)
	local vc = GetVehicleClass(veh)
	return (vc >= 0 and vc <= 7) or (vc >= 9 and vc <= 12) or (vc >= 17 and vc <= 20)
end

Citizen.CreateThread(function()
	while true do
		local timeDistance = 1000

		local ped = PlayerPedId()
		local car = GetVehiclePedIsIn(ped)
		if car ~= 0 and (ExNoCarro or IsCar(car)) then
			timeDistance = 5

			ExNoCarro = true
			if cinto_seguranca then
				DisableControlAction(0,75)
			end

			
			sBuffer[2] = sBuffer[1]
			sBuffer[1] = GetEntitySpeed(car)

			if sBuffer[2] ~= nil and not cinto_seguranca and GetEntitySpeedVector(car,true).y > 1.0 and sBuffer[1] > 10.25 and (sBuffer[2] - sBuffer[1]) > (sBuffer[1] * 0.255) then
				TaskLeaveVehicle(ped,GetVehiclePedIsIn(ped),4160)
			end

			if IsControlJustReleased(1,47) then
				if cinto_seguranca then
					TriggerEvent("vrp_sound:source","unbelt",0.5)
					cinto_seguranca = false
				else
					TriggerEvent("vrp_sound:source","belt",0.5)
					cinto_seguranca = true
				end
			end
		elseif ExNoCarro then
			ExNoCarro = false
			cinto_seguranca = false
			sBuffer[1],sBuffer[2] = 0.0,0.0
		end
		Citizen.Wait(timeDistance)
	end
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- SISTEMA CLIMATICO
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local hora = 12
local minuto = 0

Citizen.CreateThread(function()
	while true do
		NetworkOverrideClockTime( (GlobalState.time[1] or hora), (GlobalState.time[2] or minuto), 0)
		SetWeatherTypeNowPersist("CLEAR")
		Wait( 1000 )
	end
end)	

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- EXPORTS
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
exports("setMinimapActive", function(status)
	inFarm = status
end)